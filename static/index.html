<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Piri — AKIS Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06090f;--bg2:#0c1118;--bg3:#111827;--bg4:#1a2332;
  --glass:rgba(15,23,40,.65);--glass2:rgba(20,30,50,.5);
  --border:rgba(55,75,110,.25);--border2:rgba(80,110,160,.2);
  --text:#f0f2f6;--dim:#7b8ba3;--dim2:#5a6a80;
  --accent:#4f8fff;--accent2:#6ea8ff;
  --cyan:#22d3ee;--green:#34d399;--orange:#fbbf24;--red:#f87171;
  --purple:#a78bfa;--gold:#d4a053;--gold2:#f0d68a;
  --r:12px;--r2:8px;
}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;font-size:14px;line-height:1.65}
::selection{background:rgba(79,143,255,.3)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(79,143,255,.15);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:rgba(79,143,255,.3)}

/* ─── APP LAYOUT ─── */
.app{display:flex;height:100vh;position:relative}

/* ─── LEFT PANEL ─── */
.left{width:400px;min-width:360px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}
.left::after{content:'';position:absolute;top:0;right:0;bottom:0;width:1px;background:linear-gradient(to bottom,transparent,rgba(79,143,255,.1) 20%,rgba(79,143,255,.1) 80%,transparent)}

/* Brand */
.brand{padding:20px 20px 16px;text-align:center;background:linear-gradient(180deg,rgba(79,143,255,.03) 0%,transparent 100%)}
.brand-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px}
.brand-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--gold2) 0%,var(--gold) 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(212,160,83,.2)}
.brand-icon svg{width:22px;height:22px;fill:#4a3000}
.brand h1{font-size:28px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,var(--gold2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.brand-sub{font-size:11.5px;color:var(--dim);font-style:italic;letter-spacing:.3px}
.pills{display:flex;gap:6px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.pill{padding:4px 10px;background:rgba(79,143,255,.06);border:1px solid rgba(79,143,255,.12);border-radius:20px;font-size:10px;color:var(--accent2);font-weight:600;white-space:nowrap;backdrop-filter:blur(4px)}

/* Tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg3);gap:1px}
.tab{flex:1;padding:10px 4px;background:none;border:none;border-bottom:2.5px solid transparent;color:var(--dim);font-size:10.5px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;letter-spacing:.3px;text-transform:uppercase}
.tab:hover{color:var(--text);background:rgba(255,255,255,.02)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(79,143,255,.04)}
.tab svg{width:14px;height:14px;fill:currentColor;flex-shrink:0;opacity:.7}
.tab.active svg{opacity:1}

/* Form */
.form{flex:1;overflow-y:auto;padding:16px}
.panel{display:none}.panel.active{display:block}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:10px;color:var(--dim2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;font-weight:600}
textarea,input[type=text],input[type=number]{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--r2);color:var(--text);font-size:13px;font-family:inherit;resize:vertical;transition:all .25s}
textarea:focus,input:focus{outline:none;border-color:rgba(79,143,255,.5);box-shadow:0 0 0 3px rgba(79,143,255,.08)}
textarea::placeholder,input::placeholder{color:var(--dim2)}
.row{display:flex;gap:10px}.row>*{flex:1}

/* Buttons */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:11px;border:none;border-radius:var(--r2);font-size:13px;font-weight:600;cursor:pointer;width:100%;transition:all .2s;letter-spacing:.2px;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.08) 0%,transparent 60%);pointer-events:none}
.btn:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.3)}.btn:active{transform:translateY(0);filter:brightness(.95)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;filter:none}
.btn svg{width:16px;height:16px;fill:currentColor}
.btn-pri{background:linear-gradient(135deg,#4f8fff,#3366dd);color:#fff}
.btn-cy{background:linear-gradient(135deg,#22d3ee,#0891b2);color:#fff}
.btn-gn{background:linear-gradient(135deg,#34d399,#059669);color:#fff}
.btn-gd{background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff}
.btn-pp{background:linear-gradient(135deg,#a78bfa,#7c3aed);color:#fff}

/* ─── RIGHT PANEL ─── */
.right{flex:1;display:flex;flex-direction:column;background:var(--bg);position:relative}
.right::before{content:'';position:absolute;top:0;left:0;right:0;height:200px;background:radial-gradient(ellipse at 50% 0%,rgba(79,143,255,.04) 0%,transparent 70%);pointer-events:none;z-index:0}

/* Chat header */
.chtop{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;background:rgba(12,17,24,.8);backdrop-filter:blur(12px);z-index:1}
.avatar{width:46px;height:46px;border-radius:50%;background:conic-gradient(from 180deg,var(--gold2),var(--gold),#8b6914,var(--gold2));display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 0 20px rgba(212,160,83,.2)}
.avatar-inner{width:40px;height:40px;border-radius:50%;background:radial-gradient(circle at 35% 35%,var(--gold2),var(--gold));display:flex;align-items:center;justify-content:center}
.avatar-inner svg{width:20px;height:20px;fill:#4a3000}
.avatar::after{content:'';position:absolute;inset:-6px;border-radius:50%;border:1.5px solid rgba(212,160,83,.15);animation:ring 4s ease-in-out infinite}
@keyframes ring{0%,100%{transform:scale(1);opacity:.3}50%{transform:scale(1.1);opacity:.7}}
.avatar.think .avatar-inner{animation:pulse .6s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(.92)}}
.chtop-info{flex:1}
.chtop-name{font-size:16px;font-weight:700;letter-spacing:-.3px}
.chtop-status{font-size:11px;color:var(--dim);margin-top:1px}
.chtop-badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;background:rgba(52,211,153,.08);color:var(--green);border:1px solid rgba(52,211,153,.15)}

/* Chat body */
.chbody{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;z-index:1}

/* Empty state */
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:16px;color:var(--dim);padding:40px}
.empty-icon{width:80px;height:80px;border-radius:50%;background:rgba(79,143,255,.04);border:1px solid rgba(79,143,255,.08);display:flex;align-items:center;justify-content:center}
.empty-icon svg{width:36px;height:36px;fill:var(--dim2);opacity:.5}
.empty p{max-width:300px;font-size:13px;line-height:1.7;color:var(--dim2)}
.empty q{font-size:11px;color:var(--dim2);font-style:italic;display:block;margin-top:6px;opacity:.6}

/* Messages */
.msg{display:flex;gap:12px;animation:msgIn .3s ease-out}
@keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.msg-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#8b6914);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:4px;box-shadow:0 2px 8px rgba(212,160,83,.15)}
.msg-av svg{width:14px;height:14px;fill:#fff}

/* Bubble */
.bubble{flex:1;background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:18px 20px;font-size:13px;line-height:1.75;backdrop-filter:blur(8px)}
.bubble h3{font-size:14px;color:var(--accent2);margin-bottom:10px;display:flex;align-items:center;gap:8px;font-weight:700;letter-spacing:-.2px}
.bubble h3 svg{width:16px;height:16px;fill:var(--accent);flex-shrink:0;opacity:.8}
.bubble p{margin-bottom:8px;color:var(--text)}
.bubble ul,.bubble ol{margin:8px 0;padding-left:20px}.bubble li{margin-bottom:4px}

/* Highlights */
.hl{background:rgba(79,143,255,.04);border-left:3px solid var(--accent);padding:12px 16px;border-radius:0 var(--r2) var(--r2) 0;margin:10px 0;font-size:13px;line-height:1.75}
.hl p{margin-bottom:6px}.hl p:last-child{margin-bottom:0}
.hl.warn{border-left-color:var(--orange);background:rgba(251,191,36,.04)}
.hl.info{border-left-color:var(--cyan);background:rgba(34,211,238,.04)}
.hl.ok{border-left-color:var(--green);background:rgba(52,211,153,.04)}

/* Tags */
.meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
.t{padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600;display:inline-flex;align-items:center;gap:4px}
.t svg{width:10px;height:10px;fill:currentColor}
.t-time{background:var(--bg3);color:var(--dim);border:1px solid var(--border)}
.t-src{background:rgba(79,143,255,.06);color:var(--accent2);border:1px solid rgba(79,143,255,.12)}
.t-web{background:rgba(34,211,238,.06);color:var(--cyan);border:1px solid rgba(34,211,238,.12)}
.t-ok{background:rgba(52,211,153,.06);color:var(--green);border:1px solid rgba(52,211,153,.12)}
.t-method{background:rgba(167,139,250,.06);color:var(--purple);border:1px solid rgba(167,139,250,.12)}

/* Web cards */
.wcards{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.wcard{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);padding:10px 14px;transition:all .2s;border-left:3px solid var(--cyan)}
.wcard:hover{border-color:rgba(34,211,238,.3);background:rgba(17,24,39,.8)}
.wcard a{color:var(--cyan);text-decoration:none;font-weight:600;font-size:12px;line-height:1.4}.wcard a:hover{text-decoration:underline}
.wcard .dom{font-size:10px;color:var(--dim2);margin-top:2px}.wcard .snip{font-size:11px;color:var(--dim);margin-top:4px;line-height:1.5}

/* Metrics */
.metrics{display:flex;flex-direction:column;gap:4px;margin-top:10px}
.mrow{display:flex;align-items:center;gap:8px}.mlbl{width:90px;font-size:11px;flex-shrink:0;color:var(--dim)}
.mbar{flex:1;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}.mfill{height:100%;border-radius:3px;transition:width .6s ease-out}
.mval{width:40px;text-align:right;font-size:11px;font-weight:700;flex-shrink:0}

/* Score box */
.score-box{text-align:center;padding:20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);margin-bottom:12px}
.score-num{font-size:42px;font-weight:800;letter-spacing:-1px}.score-lbl{font-size:12px;font-weight:700;margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.score-bar{margin-top:10px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}.score-fill{height:100%;border-radius:3px;transition:width .6s}

/* File upload */
.drop{border:2px dashed var(--border);border-radius:var(--r);padding:24px 16px;text-align:center;cursor:pointer;background:var(--bg);transition:all .25s}
.drop:hover{border-color:var(--accent);background:rgba(79,143,255,.02)}
.drop svg{width:32px;height:32px;fill:var(--dim2);margin-bottom:6px}
.fprev{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--r2);margin-bottom:12px}
.fprev-name{font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
.fprev-name svg{width:14px;height:14px;fill:var(--accent)}
.fprev-sz{font-size:10px;color:var(--dim2);margin-left:4px}
.fprev-x{background:var(--red);color:#fff;border:none;border-radius:4px;padding:3px 8px;cursor:pointer;font-size:10px;font-weight:600;transition:.15s}
.fprev-x:hover{filter:brightness(1.2)}

/* Spinner */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .5s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Divider */
.divider{height:1px;background:var(--border);margin:8px 0}

/* ─── RESPONSIVE ─── */
@media(max-width:768px){
  .app{flex-direction:column}
  .left{width:100%;min-width:0;max-height:50vh;border-right:none;border-bottom:1px solid var(--border)}
  .left::after{display:none}
  .chbody{padding:16px}
  .chtop{padding:12px 16px}
  .bubble{padding:14px 16px;border-radius:12px}
}
@media(max-width:480px){
  .brand h1{font-size:22px}
  .tab{font-size:9px;padding:8px 2px}
  .tab svg{display:none}
  .pills{gap:4px}.pill{font-size:9px;padding:3px 6px}
}
</style>
</head>
<body>
<div class="app">
<!-- ─── LEFT ─── -->
<div class="left">
  <div class="brand">
    <div class="brand-row">
      <div class="brand-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
      <h1>Piri</h1>
    </div>
    <div class="brand-sub">Bilgi denizinde harita cikaran yapay zeka</div>
    <div class="pills">
      <span class="pill" id="st-chunk">-- chunk</span>
      <span class="pill" id="st-model">yukleniyor...</span>
      <span class="pill" id="st-ver">v3.0</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="rag"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>Soru</button>
    <button class="tab" data-t="web"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>Web</button>
    <button class="tab" data-t="search"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Ara</button>
    <button class="tab" data-t="learn"><svg viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>Ogret</button>
    <button class="tab" data-t="gen"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Uret</button>
    <button class="tab" data-t="eval"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>Deger.</button>
  </div>

  <div class="form">
    <!-- Soru -->
    <div class="panel active" id="p-rag">
      <div class="fg"><label>Sorunuz</label><textarea id="rag-q" rows="3" placeholder="Piri'ye sormak istediginiz soru..."></textarea></div>
      <div class="row">
        <div class="fg"><label>Top-K</label><input type="number" id="rag-k" value="3" min="1" max="10"/></div>
        <div class="fg"><label>Tokens</label><input type="number" id="rag-t" value="300" min="50" max="2000"/></div>
      </div>
      <button class="btn btn-pri" id="b-rag" onclick="doRAG()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>Piri'ye Sor
      </button>
    </div>

    <!-- Web -->
    <div class="panel" id="p-web">
      <div class="fg"><label>Web Arama</label><textarea id="ws-q" rows="3" placeholder="Internette ne arayalim?"></textarea></div>
      <div class="row">
        <div class="fg"><label>Sonuc Sayisi</label><input type="number" id="ws-n" value="5" min="1" max="10"/></div>
        <div class="fg" style="display:flex;align-items:flex-end;padding-bottom:14px">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="ws-learn" checked style="accent-color:var(--green);width:15px;height:15px"/>
            <span style="font-size:11px;font-weight:600">Ogren</span>
          </label>
        </div>
      </div>
      <button class="btn btn-cy" id="b-ws" onclick="doWeb()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>Web'de Ara
      </button>
    </div>

    <!-- Ara -->
    <div class="panel" id="p-search">
      <div class="fg"><label>Semantik Arama</label><textarea id="sr-q" rows="2" placeholder="Bilgi tabaninda arama yapin..."></textarea></div>
      <div class="fg"><label>Sonuc</label><input type="number" id="sr-k" value="5" min="1" max="20"/></div>
      <button class="btn btn-gn" id="b-sr" onclick="doSearch()">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Ara
      </button>
    </div>

    <!-- Ogret -->
    <div class="panel" id="p-learn">
      <div style="display:flex;gap:4px;margin-bottom:12px">
        <button class="btn" id="lm-f" onclick="setLM('file')" style="flex:1;padding:8px;background:var(--accent);color:#fff;font-size:11px;border-radius:6px;font-weight:600">Dosya Yukle</button>
        <button class="btn" id="lm-t" onclick="setLM('text')" style="flex:1;padding:8px;background:var(--bg3);color:var(--dim);font-size:11px;border:1px solid var(--border);border-radius:6px;font-weight:600">Metin Yapistir</button>
      </div>
      <div id="lf-area">
        <div class="drop" id="dropz" onclick="document.getElementById('finp').click()">
          <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11z"/></svg>
          <div style="font-size:12px;font-weight:600;margin-top:4px">Dosya surukle veya tikla</div>
          <div style="font-size:10px;color:var(--dim2);margin-top:2px">.txt .md .json .py .csv ve diger text formatlar</div>
          <input type="file" id="finp" style="display:none" accept=".txt,.md,.csv,.json,.py,.js,.ts,.html,.xml,.yaml,.yml,.log,.rst,.tex,.sql,.sh,.java,.go,.c,.cpp,.css"/>
        </div>
        <div id="fprev" style="display:none"></div>
      </div>
      <div id="lt-area" style="display:none">
        <div class="fg"><label>Metin Icerigi</label><textarea id="learn-txt" rows="5" style="font-family:'JetBrains Mono',monospace;font-size:12px" placeholder="Piri'ye ogretmek istediginiz metni buraya yapisitirin..."></textarea></div>
      </div>
      <div class="row" style="margin-bottom:12px">
        <div class="fg"><label>Kaynak Adi</label><input type="text" id="learn-src" placeholder="ornek: notlarim.md"/></div>
        <div class="fg"><label>Chunk Boyutu</label><input type="number" id="learn-cs" value="512" min="128" max="2048"/></div>
      </div>
      <button class="btn btn-gn" id="b-learn" onclick="doLearn()">
        <svg viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>Ogret
      </button>
    </div>

    <!-- Uret -->
    <div class="panel" id="p-gen">
      <div class="fg"><label>Prompt</label><textarea id="gen-p" rows="4" placeholder="Metin uretmek icin bir sey yazin..."></textarea></div>
      <div class="row">
        <div class="fg"><label>Max Tokens</label><input type="number" id="gen-t" value="150" min="20" max="500"/></div>
        <div class="fg"><label>Temperature</label><input type="number" id="gen-tmp" value="0.7" min="0" max="1.5" step="0.1"/></div>
      </div>
      <button class="btn btn-gd" id="b-gen" onclick="doGen()">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>Uret
      </button>
    </div>

    <!-- Deger -->
    <div class="panel" id="p-eval">
      <div class="fg"><label>Soru</label><textarea id="ev-q" rows="3" placeholder="Kalite degerlendirmesi icin soru..."></textarea></div>
      <div class="row">
        <div class="fg"><label>Top-K</label><input type="number" id="ev-k" value="3" min="1" max="10"/></div>
        <div class="fg"><label>Tokens</label><input type="number" id="ev-t" value="300" min="50" max="500"/></div>
      </div>
      <button class="btn btn-pp" id="b-eval" onclick="doEval()">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>Degerlendir
      </button>
    </div>
  </div>
</div>

<!-- ─── RIGHT (Chat) ─── -->
<div class="right">
  <div class="chtop">
    <div class="avatar" id="av">
      <div class="avatar-inner">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      </div>
    </div>
    <div class="chtop-info">
      <div class="chtop-name">Piri</div>
      <div class="chtop-status" id="ch-st">Hazir — bir soru sorun veya web'de arayin</div>
    </div>
    <div class="chtop-badge" id="ch-badge">v3</div>
  </div>

  <div class="chbody" id="chbody">
    <div class="empty" id="empty">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      </div>
      <p>Soldan bir soru sorun, web'de arayin veya dosya yukleyerek Piri'ye ogretin.</p>
      <q>"Haritasi olmayana her ruzgar ters eser."</q>
    </div>
  </div>
</div>
</div>

<script>
const B = document.getElementById('chbody');
const E = document.getElementById('empty');
const AV = document.getElementById('av');
const STAT = document.getElementById('ch-st');

const avSvg = '<svg viewBox="0 0 24 24" width="14" height="14"><path fill="#fff" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>';

// ─── Tabs ───
document.querySelectorAll('.tab').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  document.getElementById('p-' + b.dataset.t).classList.add('active');
}));

// ─── Stats ───
async function stats() {
  try {
    const r = await fetch('/rag/stats');
    const d = await r.json();
    document.getElementById('st-chunk').textContent = (d.total_chunks || 0) + ' chunk';
    const m = (d.model || '').split('/').pop();
    document.getElementById('st-model').textContent = (d.backend === 'openai' ? '⚡ ' : '') + m;
    document.getElementById('st-ver').textContent = 'v' + (d.version || '3.0');
  } catch (e) {}
}
stats();

// ─── Utilities ───
function esc(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

function load(id, on) {
  const b = document.getElementById(id);
  if (on) {
    b.disabled = true;
    b._h = b.innerHTML;
    b.innerHTML = '<span class="spinner"></span> Dusunuyor...';
    AV.classList.add('think');
    STAT.textContent = 'Dusunuyor...';
  } else {
    b.disabled = false;
    b.innerHTML = b._h;
    AV.classList.remove('think');
    STAT.textContent = 'Hazir';
  }
}

function addMsg(h) {
  E.style.display = 'none';
  const d = document.createElement('div');
  d.className = 'msg';
  d.innerHTML = '<div class="msg-av">' + avSvg + '</div><div class="bubble">' + h + '</div>';
  B.appendChild(d);
  B.scrollTop = B.scrollHeight;
}

// Client-side cevap temizligi (defense in depth)
function cleanAnswer(t) {
  if (!t) return '';
  // LLM artifacts
  t = t.replace(/<\|im_start\|>|<\|im_end\|>|<\|endoftext\|>|<\|end\|>/gi, '');
  t = t.replace(/^(assistant|system|user)[\s:]+/i, '');
  // Metadata satirlari
  t = t.replace(/^(Web Araması|Kaynak|Tarih|Source|Date):.*$/gim, '');
  t = t.replace(/^(Relevance|Hallucination Rate|Bildirim|Context Precision|Coverage|Coherence|Faithfulness)(\s*:\s*.*)?$/gim, '');
  t = t.replace(/^(Task completion rate|Step efficiency|Tool use accuracy)\s*:.*$/gim, '');
  t = t.replace(/^#{1,4}\s*\[?\d*\]?\s*/gm, '');
  // URL satirlari
  t = t.replace(/^https?:\/\/\S+$/gm, '');
  t = t.replace(/\(https?:\/\/[^)]+\)/g, '');
  // Markdown baslik
  t = t.replace(/^#{1,4}\s+/gm, '');
  // Bos satirlari temizle
  t = t.replace(/\n{3,}/g, '\n\n');
  return t.trim();
}

function fmtAns(t) {
  if (!t) return '';
  let c = cleanAnswer(t);
  if (!c) return '';
  
  const ps = c.split(/\n\n+/).filter(p => p.trim().length > 5);
  if (!ps.length) return '<p>' + esc(c).replace(/\n/g, '<br>') + '</p>';
  
  return ps.map(p => {
    p = p.trim();
    if (p.includes('\n- ') || p.includes('\n* ') || p.startsWith('- ') || p.startsWith('* ')) {
      const items = p.split(/\n[\-\*]\s+/).filter(x => x.trim());
      return '<ul>' + items.map(i => '<li>' + esc(i.trim()) + '</li>').join('') + '</ul>';
    }
    return '<p>' + esc(p).replace(/\n/g, '<br>') + '</p>';
  }).join('');
}

function sclr(s) {
  return s >= .75 ? 'var(--green)' : s >= .5 ? 'var(--accent)' : s >= .3 ? 'var(--orange)' : 'var(--red)';
}

// ─── RAG ───
async function doRAG() {
  const q = document.getElementById('rag-q').value;
  if (!q.trim()) return;
  load('b-rag', 1);
  const t0 = Date.now();
  try {
    const r = await fetch('/rag/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: q,
        top_k: +document.getElementById('rag-k').value,
        max_new_tokens: +document.getElementById('rag-t').value,
      }),
    });
    const d = await r.json();
    const ms = Date.now() - t0;
    const m = d.method || 'rag';
    
    let h = '<h3><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>' + esc(q) + '</h3>';
    
    // Method banner
    if (m === 'auto_web') {
      h += '<div class="hl info">Bilgi tabaninda bulunamadi — web\'den aranip ogrenildi';
      if (d.chunks_learned) h += ' (' + d.chunks_learned + ' chunk)';
      h += '</div>';
    } else if (m === 'no_info') {
      h += '<div class="hl warn">Bu konuda yeterli bilgi bulunamadi. Web Ara sekmesinden deneyebilirsiniz.</div>';
    }
    
    // Answer
    const ans = fmtAns(d.answer || d.detail || '');
    if (ans) h += '<div class="hl">' + ans + '</div>';
    
    // Web results
    if (d.web_results && d.web_results.length) {
      h += '<div style="margin-top:12px;font-size:10px;color:var(--dim2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;font-weight:600">Web Kaynaklari</div>';
      h += '<div class="wcards">';
      d.web_results.forEach(w => {
        h += '<div class="wcard"><a href="' + w.url + '" target="_blank">' + esc(w.title) + '</a>';
        h += '<div class="dom">' + esc(w.source) + '</div></div>';
      });
      h += '</div>';
    }
    
    // Sources (sadece pozitif skorlu)
    if (d.retrieval_scores && d.retrieval_scores.length) {
      h += '<div class="meta">';
      d.retrieval_scores.forEach(s => {
        const c = sclr(s.score > 0 ? Math.min(s.score / 5, 1) : 0);
        h += '<span class="t t-src" style="border-color:' + c + ';color:' + c + '">' + esc(s.source) + ' ' + s.score.toFixed(1) + '</span>';
      });
      h += '</div>';
    }
    
    // Meta tags
    const ml = { rag: 'RAG', auto_web: 'Web+RAG', no_info: '—' }[m] || m;
    h += '<div class="meta">';
    h += '<span class="t t-time">' + ms + 'ms</span>';
    h += '<span class="t t-method">' + ml + '</span>';
    if (d.backend) h += '<span class="t t-ok">' + d.backend + '</span>';
    h += '</div>';
    
    addMsg(h);
    stats();
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-rag', 0);
}

// ─── Web ───
async function doWeb() {
  const q = document.getElementById('ws-q').value;
  if (!q.trim()) return;
  load('b-ws', 1);
  STAT.textContent = "Web'de araniyor...";
  const t0 = Date.now();
  try {
    const r = await fetch('/rag/web-search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: q,
        max_results: +document.getElementById('ws-n').value,
        auto_learn: document.getElementById('ws-learn').checked,
        top_k: 3,
      }),
    });
    const d = await r.json();
    const ms = Date.now() - t0;
    
    let h = '<h3><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>' + esc(q) + '</h3>';
    
    if (d.learned) {
      h += '<div class="hl ok">' + d.chunks_added + ' yeni bilgi ogrenildi! Piri artik bu konuda bilgi sahibi.</div>';
    }
    
    if (d.answer) {
      h += '<div class="hl">' + fmtAns(d.answer) + '</div>';
    }
    
    if (d.web_results && d.web_results.length) {
      h += '<div style="margin-top:14px;font-size:10px;color:var(--dim2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;font-weight:600">Web Sonuclari (' + d.web_results.length + ')</div>';
      h += '<div class="wcards">';
      d.web_results.forEach(w => {
        h += '<div class="wcard"><a href="' + w.url + '" target="_blank">' + esc(w.title) + '</a>';
        h += '<div class="dom">' + esc(w.source) + '</div>';
        if (w.snippet) h += '<div class="snip">' + esc(w.snippet) + '</div>';
        h += '</div>';
      });
      h += '</div>';
    }
    
    h += '<div class="meta"><span class="t t-time">' + ms + 'ms</span>';
    if (d.source_name) h += '<span class="t t-ok">' + esc(d.source_name) + '</span>';
    if (d.total_chunks) h += '<span class="t t-src">' + d.total_chunks + ' chunk</span>';
    h += '</div>';
    
    addMsg(h);
    stats();
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-ws', 0);
}

// ─── Search ───
async function doSearch() {
  const q = document.getElementById('sr-q').value;
  if (!q.trim()) return;
  load('b-sr', 1);
  const t0 = Date.now();
  try {
    const r = await fetch('/rag/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: q, top_k: +document.getElementById('sr-k').value }),
    });
    const d = await r.json();
    const ms = Date.now() - t0;
    
    let h = '<h3><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>' + esc(q) + '</h3>';
    h += '<div style="font-size:11px;color:var(--dim);margin-bottom:10px">' + d.total_found + ' sonuc &middot; ' + ms + 'ms</div>';
    
    if (d.results) {
      d.results.forEach(it => {
        const sc = it.score > 0 ? Math.min(it.score / 5, 1) : 0;
        const c = sclr(sc);
        h += '<div style="background:var(--glass);border:1px solid var(--border);border-left:3px solid ' + c + ';border-radius:' + 'var(--r2)' + ';padding:10px 14px;margin-bottom:8px">';
        h += '<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
        h += '<span class="t t-src">' + esc(it.source) + '</span>';
        h += '<span style="font-size:11px;font-weight:700;color:' + c + '">' + it.score.toFixed(2) + '</span></div>';
        h += '<div style="font-size:12px;color:var(--dim);line-height:1.6">' + esc(it.text) + '</div></div>';
      });
    }
    addMsg(h);
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-sr', 0);
}

// ─── Generate ───
async function doGen() {
  const p = document.getElementById('gen-p').value;
  if (!p.trim()) return;
  load('b-gen', 1);
  const t0 = Date.now();
  try {
    const r = await fetch('/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: p,
        max_new_tokens: +document.getElementById('gen-t').value,
        temperature: +document.getElementById('gen-tmp').value,
      }),
    });
    const d = await r.json();
    const ms = Date.now() - t0;
    
    let h = '<h3><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>' + esc(p) + '</h3>';
    h += '<div class="hl">' + fmtAns(d.text || '') + '</div>';
    h += '<div class="meta"><span class="t t-time">' + ms + 'ms</span>';
    h += '<span class="t t-method">' + (d.method || 'generate') + '</span></div>';
    
    addMsg(h);
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-gen', 0);
}

// ─── Evaluate ───
async function doEval() {
  const q = document.getElementById('ev-q').value;
  if (!q.trim()) return;
  load('b-eval', 1);
  const t0 = Date.now();
  try {
    const r = await fetch('/rag/evaluate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: q,
        top_k: +document.getElementById('ev-k').value,
        max_new_tokens: +document.getElementById('ev-t').value,
      }),
    });
    const d = await r.json();
    const ms = Date.now() - t0;
    const ev = d.evaluation;
    const sc = ev.overall_score;
    const col = sclr(sc);
    
    let h = '<h3><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>' + esc(q) + '</h3>';
    
    h += '<div class="score-box"><div class="score-num" style="color:' + col + '">' + sc.toFixed(2) + '</div>';
    h += '<div class="score-lbl" style="color:' + col + '">' + ev.verdict + '</div>';
    h += '<div class="score-bar"><div class="score-fill" style="width:' + (sc * 100) + '%;background:' + col + '"></div></div></div>';
    
    h += '<div class="hl">' + fmtAns(d.answer || '') + '</div>';
    
    const mn = { faithfulness: 'Faithfulness', relevance: 'Relevance', context_precision: 'Precision', coverage: 'Coverage', coherence: 'Coherence' };
    h += '<div class="metrics">';
    for (const [k, v] of Object.entries(ev.metrics)) {
      const c2 = sclr(v.score);
      h += '<div class="mrow"><span class="mlbl">' + (mn[k] || k) + '</span>';
      h += '<div class="mbar"><div class="mfill" style="width:' + (Math.max(0, v.score) * 100) + '%;background:' + c2 + '"></div></div>';
      h += '<span class="mval" style="color:' + c2 + '">' + v.score.toFixed(2) + '</span></div>';
    }
    h += '</div>';
    h += '<div class="meta"><span class="t t-time">' + ms + 'ms</span></div>';
    
    addMsg(h);
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-eval', 0);
}

// ─── Learn ───
let lmode = 'file', selFile = null;

function setLM(m) {
  lmode = m;
  const fb = document.getElementById('lm-f');
  const tb = document.getElementById('lm-t');
  if (m === 'file') {
    fb.style.cssText = 'flex:1;padding:8px;background:var(--accent);color:#fff;font-size:11px;border-radius:6px;font-weight:600;border:none;cursor:pointer';
    tb.style.cssText = 'flex:1;padding:8px;background:var(--bg3);color:var(--dim);font-size:11px;border:1px solid var(--border);border-radius:6px;font-weight:600;cursor:pointer';
    document.getElementById('lf-area').style.display = 'block';
    document.getElementById('lt-area').style.display = 'none';
  } else {
    tb.style.cssText = 'flex:1;padding:8px;background:var(--accent);color:#fff;font-size:11px;border-radius:6px;font-weight:600;border:none;cursor:pointer';
    fb.style.cssText = 'flex:1;padding:8px;background:var(--bg3);color:var(--dim);font-size:11px;border:1px solid var(--border);border-radius:6px;font-weight:600;cursor:pointer';
    document.getElementById('lf-area').style.display = 'none';
    document.getElementById('lt-area').style.display = 'block';
  }
}

const dz = document.getElementById('dropz');
const fi = document.getElementById('finp');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.borderColor = 'var(--accent)'; });
dz.addEventListener('dragleave', () => { dz.style.borderColor = 'var(--border)'; });
dz.addEventListener('drop', e => { e.preventDefault(); dz.style.borderColor = 'var(--border)'; if (e.dataTransfer.files.length) pickFile(e.dataTransfer.files[0]); });
fi.addEventListener('change', () => { if (fi.files.length) pickFile(fi.files[0]); });

function pickFile(f) {
  selFile = f;
  dz.style.display = 'none';
  const pv = document.getElementById('fprev');
  pv.style.display = 'block';
  pv.innerHTML = '<div class="fprev"><div class="fprev-name"><svg viewBox="0 0 24 24"><path fill="var(--accent)" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>' + esc(f.name) + '<span class="fprev-sz">' + (f.size / 1024).toFixed(1) + 'KB</span></div><button class="fprev-x" onclick="clearF()">X</button></div>';
  if (!document.getElementById('learn-src').value) document.getElementById('learn-src').value = f.name;
}

function clearF() {
  selFile = null;
  fi.value = '';
  document.getElementById('fprev').style.display = 'none';
  dz.style.display = 'block';
}

async function doLearn() {
  load('b-learn', 1);
  const t0 = Date.now();
  try {
    let resp;
    if (lmode === 'file') {
      if (!selFile) { alert('Dosya secin'); load('b-learn', 0); return; }
      const fd = new FormData();
      fd.append('file', selFile);
      const sn = document.getElementById('learn-src').value;
      if (sn) fd.append('source_name', sn);
      fd.append('chunk_size', document.getElementById('learn-cs').value);
      resp = await fetch('/rag/upload', { method: 'POST', body: fd });
    } else {
      const txt = document.getElementById('learn-txt').value;
      if (!txt.trim()) { alert('Metin girin'); load('b-learn', 0); return; }
      resp = await fetch('/rag/learn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: txt,
          source_name: document.getElementById('learn-src').value || 'metin',
          chunk_size: +document.getElementById('learn-cs').value,
        }),
      });
    }
    const d = await resp.json();
    const ms = Date.now() - t0;
    
    if (resp.ok) {
      let h = '<h3><svg viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>Ogrenme Tamamlandi</h3>';
      h += '<div class="hl ok">' + d.message + '</div>';
      h += '<div class="meta">';
      h += '<span class="t t-time">' + ms + 'ms</span>';
      h += '<span class="t t-ok">' + d.chunks_added + ' chunk</span>';
      h += '<span class="t t-src">' + esc(d.source) + '</span>';
      h += '</div>';
      addMsg(h);
      stats();
    } else {
      addMsg('<p style="color:var(--red)">' + (d.detail || 'Hata') + '</p>');
    }
  } catch (e) {
    addMsg('<p style="color:var(--red)">Hata: ' + e.message + '</p>');
  }
  load('b-learn', 0);
}

// Keyboard shortcut: Enter to submit on textareas
document.querySelectorAll('textarea').forEach(ta => {
  ta.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const panel = ta.closest('.panel');
      if (panel) {
        const btn = panel.querySelector('.btn');
        if (btn && !btn.disabled) btn.click();
      }
    }
  });
});
</script>
</body>
</html>
